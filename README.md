# Onliner Cart API

Адрес API - https://cart.api.onliner.by.

Ресурс доступен только по протоколу HTTPS.

Все информация о временных отметках передается в виде строки в формате [ATOM RFC3339](https://tools.ietf.org/html/rfc3339) (пример: 2005-08-15T15:52:01+00:00).

Для всех запросов следует указывать HTTP заголовок **Accept**. По умолчанию его необходимо передавать со значением *application/json*.

Если происходит передача данных от клиента на сервер (например, при выполнении запросов типа POST, PATCH, DELETE), необходимо указывать заголовок **Content-Type** со значением *application/json*.

При выполнении каждого запроса в заголовках запроса необходимо передавать заголовок **Authorization** cо значением *Bearer %AUTH_TOKEN%*,
где *%AUTH_TOKEN%* - авторизационный токен, полученный после [авторизации на стороне b2bapi](https://github.com/onlinerby/onliner-b2b-api/blob/master/docs/oauth20.md).

Примечание: авторизационный токен для работы с cart.api несколько длиннее, чем токен для работы с b2b-api. Это нормально.
 
Для работы с cart.api необходимо зарегистрировать новое приложение на [странице настройки API](https://b2b.onliner.by/pricelists).

**Для получения уведомлений об изменениях в API нажмите кнопку Watch вверху страницы. Полный список изменений вы сможете увидеть в файле CHANGELOG**

- [Список изменений](CHANGELOG.md)
- [Получение доступа к API](https://github.com/onlinerby/onliner-b2b-api/blob/master/docs/oauth20.md)

# ВНИМАНИЕ! Внесены изменения в API без поддержки старого формата! 

Выполнен плавный переход на новый жизненный цикл заказа.
В связи с этим, некоторое время будут существовать заказы, оформленные как по старому сценарию, так и по новому. 
Это связано с существованием старых версий наших мобильных приложений, через которые создаются заказы.

Признаком, по которому можно отличить заказ, оформленный по старому сценарию, от заказа, оформленного по новому сценарию будет являться свойство - `is_new_flow`.

В связи с увеличением количества статусов введены новые лимиты для обработки заказа в том или ином статусе.
В случае превышения лимита времени, заказ будет переведен в статус "Отменен системой".

Временные лимиты могут быть изменены, но информация об этом будет опубликована заранее.
Временные лимиты будут доступны позднее, на странице с [описанием Корзины](https://b2bblog.onliner.by/cart).
Актуальная информация о текущем временном лимите на обработку по прежнему будет передаваться в полях `process_deadline` и `process_time_left` в зависимости от текущего статуса заказа.

Для удобства интеграции в Ваши системы по управлению доставкой, информация о пользователе и адресе доставки расширена.

Добавлены отдельные поля для имени и фамилии в блоке с контактной информацией пользователя.
Добавлены детальные поля для описания адреса доставки.
Добавлены поля с информацией о способе доставке (на данный момент доступна только курьерская доставка), о стоимости и сроках доставки (вычисленные на основании Вашей тарифной сетки) и комменатрий к доставке, от магазина.

Добавлено поле с инфомацией о выбранном способе оплаты (наличными, картой курьеру, безналичный расчет, online-оплата).

Поле `order_cost` для новых заказов включает в себя стоимость заказа с рассчитанной стоимостью доставки.

## Онлайн-оплата

Если в Вашей тарифной сетке указана оплата картой онлайн, то пользователи могут оформить заказ с использованием данного способа оплаты.
Контроль за проведением оплаты происходит на стороне Сart API.
В случае положительного сценария для онлайн оплаты не требуется никаких дополнительных действий на стороне магазина в случае взаимодействия с нашим API.
Если онлайн-оплата по каким либо причинам не прошла, то магазин может изменить способ оплаты на оффлайн (подразумевается, что данная операция согласована с покупателем).

Онлайн оплата происходит в 2 этапа. 
При оформлении заказа денежные средства блокируются на счету покупателя (статус оплаты `authorized`)
Окончательное списание происходит только после доставки заказа покупателю.

Для завершения заказа Ваш курьер должен отсканировать QR-код, связанный с заказом, который предоставит покупатель в момент доставки.
Для сканирования QR-кодов у курьера должно быть установлено специальное приложения для смартфона.

В случае отмены заказа с онлайн-оплатой, авторизованные у покупателя денежные средства будут возвращены покупателю. 
Время возврата зависит от банка-эмитента. 

Статусы оплаты `authorizing`, `auth_cancelling_failed` и `capturing` являются техническими и используются для блокировки заказа на время выполнения операций с банком.
В случае корректно работающей системы заказ может находится в каждом из них в течении нескольких минут.
Изменение заказа в данных статусах невозможно ни покупателем, ни магазином. 

## Статусы заказа и жизненный цикл заказа (новая версия, актуальна с января 2020)

| Код статуса | Название статуса | Описание статуса |
|---|---|---|
| `new` | Новый | Заказ оформлен покупателем и ожидает реакции магазина |
| `processing` | В обработке | Заказ принят в обработку магазином |
| `confirmed` | Подтвержден | Заказ подтвержден магазином и готовится к доставке покупателю |
| `shipping` | Передан в доставку | Заказ передан в доставку к покупателю, находится в пути |
| `delivered` | Доставлен | Заказ выполнен и доставлен покупателю |
| `shop_canceled` | Отменен магазином | Заказ отменен магазином и не может быть выполнен |
| `user_canceled` | Отменен покупателем | Заказ отменен покупателем |
| `expired` | Просрочен | Магазин не успел принять в работу новый заказ в течение отведенного времени |
| `system_canceled` | Отменен системой | Магазин не успел перевести заказ в последующий статус (кроме обработки новых заказов) |

Контактная информация пользователя и адрес доставки для магазина будут доступны, когда заказ находится в статусах:
- В обработке
- Подтвержден
- Передан в доставку
- Доставлен

## Статусы онлайн оплаты

| Код статуса | Название статуса |
|---|---|
| `unknown` | Статус оплаты по умолчанию для старых заказов |
| `authorizing` | В процессе авторизации средств |
| `auth_failed` | Авторизация средств не удалась |
| `not_paid` | Не оплачен |
| `authorized` | Средства авторизованы |
| `auth_cancelling` | В процессе отмены авторизации средств |
| `auth_cancelling_failed` | Отмена авторизации средств не удалась |
| `auth_canceled` | Авторизация средств отменена |
| `capturing` | В процессе списания средств |
| `captured` | Средства списаны |
| `capture_failed` | Списание средств не удалось |

## Способы оплаты

| Код способа оплаты | Название способа оплаты |
|---|---|
| `online` | Оплата банковской картой онлайн |
| `cash` | Оплата наличными при получении |
| `terminal` | Оплата картой при получении |
| `cashless` | Оплата безналичным переводом для юрлиц |

## Статусы заказа и жизненный цикл заказа (старая версия, перестанет поддерживаться в начале 2020)

| Код статуса | Название статуса | Описание статуса |
|---|---|---|
| `new` | Новый | Заказ оформлен покупателем и ожидает подтверждения со стороны магазина |
| `confirmed` | Подтвержден | Заказ подтвержден магазином и находится в обработке (в том числе в процессе доставки покупателю) |
| `delivered` | Доставлен | Заказ выполнен и полностью доставлен покупателю |
| `shop_canceled` | Отменен магазином | Заказ отменен магазином и не может быть выполнен |
| `user_canceled` | Отменен покупателем | Заказ отменен покупателем |
| `expired` | Просрочен | Магазин не успел обработать новый заказ в течение отведенного времени на обработку заказов |

Покупатель может отменить заказ в любой момент.

Статус "Просрочен" назначается системой автоматически, если магазин не успел отменить или подтвердить заказ в течение отведенного времени на обработку заказов.

Статус "Доставлен" может назначаться системой автоматически после перевода в статус "Подтвержден" через 2 недели + максимальное количество дней доставки среди товаров в заказе. Настоятельно рекомендуется вручную изменять статус заказа на "Доставлен", но ТОЛЬКО после фактической доставки всего заказа покупателю.

Если заказ находится в статусах, отличных от "Подтвержден" или "Доставлен", то контактная информация пользователя и адрес доставки (кроме города) для магазина будут недоступны.

## Доступные методы API

|Ресурс|Описание|
|---|---|
| [GET /orders](docs/order/index.md) | Список заказов магазина |
| [GET /orders/{orderKey}](docs/order/show.md) | Получение информации о заказе |
| [PATCH /orders/{orderKey}](docs/order/update.md) | Изменить заказ |
| [POST /orders/{orderKey}/change-payment-type](docs/order/change-payment-type.md) | Изменить способ оплаты заказа |
| [POST /orders/{orderKey}/shop-comments](docs/order/internal_comments/create.md) | Добавить к заказу внутренний комментарий магазина |
| [GET /orders/{orderKey}/shop-comments](docs/order/internal_comments/list.md)| Получить список внутренних комментариев для магазина по заказу |
| [GET /resources/shop-cancel-reasons](docs/resources/shop_cancel_reasons.md) | Cписок доступных причин для отмены заказа магазином |

## В случае возникновения проблем либо технических вопросов по работе с API, создавайте Issue в данном репозитории.
